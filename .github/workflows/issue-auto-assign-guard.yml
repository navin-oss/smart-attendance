name: Issue Auto Assignment Guard

on:
  issue_comment:
    types: [created]

jobs:
  assignment-guard:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read

    steps:
      - name: Handle assignment request
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = context.payload.comment.body.toLowerCase();
            const author = context.payload.comment.user.login;
            const issue = context.payload.issue;

            // Ignore bots
            if (context.payload.comment.user.type === "Bot") return;

            // Flexible keyword groups (semantic matching)
            const intentWords = [
              "assign",
              "take",
              "work",
              "handle",
              "pick",
              "do",
              "fix",
              "solve"
            ];

            const selfWords = [
              "me",
              "i",
              "myself"
            ];

            // Check if comment *sounds like* an assignment request
            const looksLikeAssignmentRequest =
              intentWords.some(w => commentBody.includes(w)) &&
              selfWords.some(w => commentBody.includes(w));

            if (!looksLikeAssignmentRequest) return;

            // If issue already assigned
            if (issue.assignees.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âš ï¸ @${author}  
                This issue is already assigned.  
                Please check the assigned contributor or ask the maintainers if it becomes free.`
                              });
                              return;
                            }
                
                            // Fetch open issues already assigned to this user
                            const { data: assignedIssues } = await github.rest.issues.listForRepo({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              state: "open",
                              assignee: author,
                            });
                
                            // Fetch open PRs by this user
                            const { data: prs } = await github.rest.pulls.list({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              state: "open",
                            });
                
                            const hasOpenPR = prs.some(pr => pr.user.login === author);
                
                            // If user already has an assigned issue and no PR
                            if (assignedIssues.length > 0 && !hasOpenPR) {
                              await github.rest.issues.createComment({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                issue_number: issue.number,
                                body: `ðŸ‘‹ @${author}
                
                You already have an **assigned open issue**.
                
                ðŸ‘‰ Please complete it first before taking a new one.  
                ðŸ‘‰ If you have **already raised a PR**, share the PR link here and weâ€™ll assign this issue.
                
                Thanks for contributing ðŸš€`
                              });
                              return;
                            }
                
                            // Assign the issue
                            await github.rest.issues.addAssignees({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: issue.number,
                              assignees: [author],
                            });
                
                            await github.rest.issues.createComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: issue.number,
                              body: `âœ… **Assigned to @${author}**
                
                All the best! ðŸš€  
                Feel free to ask questions or share progress updates here.`
                            );
